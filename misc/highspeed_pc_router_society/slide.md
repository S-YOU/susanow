
# 環境に対して自動最適化する高性能通信基盤

- 高速PCルータ研究会2017.08 in 田町
- Hiroki SHIROKURA @slankdev slank.dev@gmail.com

## TL;DR

環境に対して自動最適化する高性能通信基盤

- 環境
	- トラフィック状態
	- コンピュータリソース
	- etc
- 自動最適化
	- スレッドチューニング
	- 全体スループットを最高性能化
	- 多数VNFをオプティマルに
- 高性能
	- スループットに重点
	- 10GbE x8, 64 Byte
	- 40GbE x2, 128 Byte
- 通信基盤
	- notVM NFV Infrastructure
	- VNF開発者の負担を減らし, VNFをデプロイ可能

まだ未完成. BCP(BestCurrentPractice)をお話します


## 背景1 昨今の通信業界の概念

- NFV: Network Function Virtualization
- SFC: Service Function Chaining
- ソフトウェアメリット
	- フレキシブル, 機能追加の容易性
	- 高速デプロイ
	- 低コスト
- 大規模サービスの社会では高速にスケールする必要性


## 背景2 DPDKの影響, 現状の問題点　

- アイディア
	- Kernelのボトルネックを解消
	- ボトルネックの無いアーキテクチャを再設計
- アプローチ
	- CPU専有
	- ユーザランドドライバによりZerocopy
	- Pagefaultを起こさないためのHugepages
- 高性能通信に必要なライブラリの集合
	- Thread Manager
	- Userland Driver
	- Lock-Free Ring
	- Algorithm
	- Memory Manager
- 最適化テクニック
	- ソフトウェアパイプライン
	- NICコンフィグ
	- メモリコピーを少なく (なくす)
	- 効率良いルックアップ
	- 排他制御の性能低下
	- バルク処理


## 目的

- 背景: VMオーバヘッド上でのNVFは最高性能ではない
- 背景: DPDKのスレッド最適化は一般的に解決できそう
- 目的: 環境情報からスレッドのパイプラインを自動最適化
- 開発: 複数NFのデプロイするNFV基盤 (no VM)

- Callenge: 限界まで無駄のないソフトウェアパイプライン
- ターゲットは10GbE x4-8, 40GbE x4くらい
- コア数がどんどん上昇することを前提 (20core~256core)


## 設計1 全体概要

- DPDKのラップ
	- スレッド管理 (Native/Green)
	- port管理 (Physical/Virutual)
	- timer管理
	- ロックレスデータ構造
- VNF管理
- 自動最適化エンジン
- フロントエンド (WebUI/VTY)


## 設計2 DPDKのラップ

- スレッド管理 (Native/Green)
	- lthreadのスケジューラアクセスをシリアライズ
- port管理 (Physical/Virutual)
	- 仮装ポート,物理ポートのインターフェースを統一
	- 性能計測機能を追加
- timer管理
	- タイマーオブジェクトクラスとしてラップ
- ロックレスデータ構造
	- 性能計測機能を追加


## 設計3 VNFの実装

- ユーザ(NF開発者)の実装部分
	- NF = {スレッドの集合, IOポート, 最低限のpipeline情報}
	- ソフトウェアパイプラインの最適化はしない


## 設計4 仮装ポート

- NIC, RteRingを同一インターフェースに統一
- NICには統計情報機能があるが, ringにはないので, 拡張
- パイプラインの各ステージからアクセス


## 設計5 パフォーマンス管理部分

- NFのスループットを測る
	- 各パイプラインのスループットの最小値
		- 各パイプラインの性能計測に帰着!


## 設計6 自動最適化部分

1. 発火フェーズ
	- VNFを追加したり減らしたりするタイミングでOptimization
	- トラフィックが増えたり, 減ったりするタイミングでOptimization
2. 発見フェーズ (環境情報より発見)
	- NICのスループット
	- スレッド状態(launch数,遅延)
	- 空きCPUの個数
3. 修正フェーズ
	- スレッドの多重度
	- NICチューニング


## 評価, 案検討中

- どのような構成でどうやって検証をすればよいのか
- @yasu 卒業研究と同スペックでNetVMやOVSと勝負ができるかも
- NFVサービスチェインが迅速にいじれて高性能なことを売りにしたい


## デモ1 スレッドチューニングの動的最適化
トラフィックが増えたタイミングで発火する自動最適化エンジン
## デモ2 VNFを新たにデプロイした場合の自動最適化エンジン

## まとめ1 なぜこのようなことが可能になるのか

各ステージの性能の定義を結構無理やりやった。
一般的な構造ではない
ネットワークスタックのような通り抜けしない構造は想定していない
ルータやFirewallやIDSなどを想定
ターゲット設定を限定したことと、ユーザの開発部分をある程度
束縛することで実現した


## まとめ2 Susanow概要

- テストで使える計算機環境を貸し出してくれるところを探しています。
  とくに契約とか結ばないでゆるふわにかしてもらいたいです。
  because of MITO-RULEs
- できれば40coreくらい使いたい...



