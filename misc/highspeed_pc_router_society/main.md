

# 環境に対して自動最適化する高性能通信基盤

- 高速PCルータ研究会2017.08 in 田町
- Hiroki SHIROKURA
- @slankdev

## TL;DR

環境に対して自動最適化する高性能通信基盤

- 環境に対して自動最適化
	- DPDKアプリケーションのスレッドチューニングを自動で行う
	- 多数VNFをオプティマルに動かす手伝いをする
	- 環境情報から最適化
		- トラフィック状態
		- コンピュータリソース
		- VNF状態
		- etc
- 通信基盤
	- notVM NFV
	- NFViとして開発する
	- VNF開発者の負担を減らし,
	- ルータやFirewallなどのネットワーク機能(NF)をデプロイする


## 背景

- 昨今の通信業界の概念
	- NFV
		- ネットワーク機能(NF)を汎用PC上の仮想的(ソフト)に実現
	- サービスチェイニング
		- 複数のNFを数珠繋ぎ. 高機能なNFとみなす
	- ソフトウェアのほうが圧倒的にフレキシブル。性能に関しては....
- DPDK
	- 最適化はスレッドチューニング
	- DPDKは全部再実装しなおすことで高性能IOの実現をした
	- パケット処理に特化した専用アプローチ
	- 専用機器に匹敵する性能を実現
	- 性能維持のためにkernelとは関わらない (もちろん連携も可)
	- CPUの論理コアを1つのスレッドで占有
	- ユーザランド上で独自のポーリング専用NICドライバ
	- Hugepagesを用いた独自のメモリ管理
	- 用途例
		- ルータ (ex, Brocade Vyatta)
		- Openflowスイッチ
		- 2017.6時点のアカデミアでの最速はBGP full route 145Gbps
	- DPDKを用いて高性能NFを実装するには？
		- NFの実装に必要な知識
			- あたり前だが実装するプロトコルの知識
		- 高性能化に必要な知識
			- 並列分散処理
			- ソフトウェアパイプライン
			- メモリコピー
			- 排他制御
			- パケット処理に対する愛
		- 性能計測をしながらソフトウェアパイプラインの最適化,
			NICの構成変更などをたくさん試して無駄を減らす
		- 要するに超楽しいけど大変
- NFV 多数VNFのサービスチェイニング
- スレッドのpipeline構造の最適化の手作業
- VMオーバヘッドなどに対してはあとから対処している。

- ひらめき
	- DPDKはNFの実装に対してもっとも無駄のないようにに設計されている
	- NFが複数に増えたらVM上でDPDK NFを実装 -> だめでは
	- VM使わないでやろう

- まとめ
	- コンセプト
		- 環境情報から自動最適化
		- 複数NFのデプロイするNFV基盤 (no VM)
	- 環境情報
		- NICのスループット
		- スレッドの数, 遅延
		- 空きCPUの個数
	- チューニング内容
		- green/native スレッド
		- スレッドの多重度
		- NICチューニング
	- ユーザ(NF開発者)の実装部分
		- NF = {スレッドの集合, IOポート, 最低限のpipeline情報}
		- ソフトウェアパイプラインの最適化はしない
	- Callenge: 限界まで無駄のないソフトウェアパイプライン


## Susanow 概要

- ターゲットは10GbE x4-8, 40GbE x4くらい
	- 私が知っているDPDKの限界がそこであるので。
- 多くのNFViはVMを使う -> VMオーバヘッド
- コア数がどんどん上昇することを前提
- 動的最適化　
	- SSNはスレッドベースでのMostOptimalを目指す
	- VNFを追加したり減らしたりするタイミングでOptimization
	- トラフィックが増えたり, 減ったりするタイミングでOptimization
	- マルチコア, メニーコアの最適化


- DPDK VNFの開発　
	- スレッドのデザイン
	- メモリコピーを少なく
	- 効率良いルックアップ
	- スレッドのパイプライニングの定義
- スレッドの部分を自動で最適化
	- NFの実装に必要な知識
		- あたり前だが実装するプロトコルの知識
	- 高性能化に必要な知識
		- 並列分散処理
		- ソフトウェアパイプライン
		- メモリコピー
		- 排他制御
		- 性能計測をしながらソフトウェアパイプラインの最適化,
		- NICの構成変更などをたくさん試して無駄を減らす
- ソフトウェアパイプラインの最適化
	- 遅延と多重率の調節は自動化できるのでは？


## 設計

- パイプラインの1ステージをclickの1モジュールと考える
- 現状パイプラインの形は直列一本に限られるが,木構造であるのが望ましい
- スレッド管理の設計
- VNFの設計
- 動的自動最適化技術の設計
- 仮想ポートの実装
- 制御インターフェース


## 実装
## 評価
### なぜこのようなことが可能になったか

各ステージの性能の定義を結構無理やりやった。
一般的な構造ではない
ネットワークスタックのような通り抜けしない構造は想定していない
ルータやFirewallやIDSなどを想定
ターゲット設定を限定したことと、ユーザの開発部分をある程度
束縛することで実現した


## デモ

- トラフィックが増えたタイミングで発火する自動最適化エンジン
- それを実装したプロトタイプのデモ



